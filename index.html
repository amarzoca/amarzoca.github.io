<!DOCTYPE html>
<html>
  	<head>

	  	<link rel="stylesheet" href="./css/bootstrap.css" /> 
	    <style type="text/css">
	      html, body, .row, .container-fluid { height: 100%; width:100%; margin: 0; padding: 0;}
	      .row>div {height:100%;}
	      #map-canvas { padding: 0;}
	      .checkbox {margin-left:8px; margin-bottom:3px;}
	      .checkbox:first-of-type {margin-top:-5px;}

	      
	    </style>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src= "http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>

	    <script type="text/javascript" src="./js/bootstrap.js"> </script>

	    <script type="text/javascript"
	      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDfEGRgJCleog0v6QuMAAa6U-JMObrn68&region=RO&libraries=places,geometry">
	    </script>

	    <script type="text/javascript">

	    var map;
	    var geocoder = new google.maps.Geocoder();
	    var autocomplete, places;

	    var directionsService = new google.maps.DirectionsService();

		var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});


	    function getCoord() {
	      	var lat = 45.7597, lng = 21.2300;
	      	var here = new google.maps.LatLng(lat, lng);

	      	if (navigator.geolocation) {
	        	navigator.geolocation.getCurrentPosition(function (res) {
	        		lat = res.coords.latitude;
	        		lng = res.coords.longitude;
	        		here = new google.maps.LatLng(lat, lng);

	        		initialize(here);
	        	});
	    	} 
	    	else { 
	    		initialize(here);
	    	}
	  	}

	    function initialize(here) {

	    	var there = new google.maps.LatLng(here.lat()-0.002, here.lng()-0.005);
	 
	        var mapOptions = {
	        	center: here,
	        	streetViewControl: true,
	        	zoomControlOptions: {
	        		position: google.maps.ControlPosition.TOP_LEFT
	    		},
	          zoom: 16
	        };

	        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	        directionsDisplay.setMap(map);

	        autocomplete = new google.maps.places.Autocomplete(document.getElementById('here'));
	        autocomplete2 = new google.maps.places.Autocomplete(document.getElementById('there'));


	        var marker = new google.maps.Marker({
	      		position: here,
	      		draggable:true,
	      		icon:'./blue.png'

	    	});
	    	var marker2 = new google.maps.Marker({
	      		position: there,
	      		draggable:true,
	      		icon:'./green.png'

	    	});
	    	var markers = new Array(marker,marker2);
	    	$('#route').click(function () { 
	    		calcRoute(marker,marker2);
	    	});

	    	var infowindow = new google.maps.InfoWindow({
	      		content: "Search or drag blue marker"
	  		});
	  		var infowindow2 = new google.maps.InfoWindow({
	      		content: "Search or drag green marker"
	  		});
	  		var windows = new Array(infowindow,infowindow2);


	  		markers.forEach(function(m,i) {
	  			m.setMap(map);
	  			getMe(m.getPosition(),m,windows[i],i);

		    	google.maps.event.addListener(m, 'dragend', function() {
		    		getMe(this.getPosition(), this, windows[i], i);
		    		calcRoute(marker,marker2);
		  		});

		  		google.maps.event.addListener(m, 'click', function() {
	  				windows[i].open(map,this);
	  				map.panTo(this.getPosition());
	  			});

	  		});
	  		map.panTo(here);

	  		google.maps.event.addListener(autocomplete, 'place_changed', function () {
	  			var res=autocomplete.getPlace();
            	marker.setPosition(res.geometry.location);
            	map.panTo(marker.getPosition());
            	infowindow.setContent("<strong> You are here: </strong> <br>" + res.formatted_address);
        	});
        	google.maps.event.addListener(autocomplete2, 'place_changed', function () {
	  			var res=autocomplete2.getPlace();
            	marker2.setPosition(res.geometry.location);
            	map.panTo(marker2.getPosition());
            	infowindow2.setContent("<strong> Friend is here: </strong> <br>" + res.formatted_address);
        	});

	    }

	    function getMe(here, marker, infowindow, which) {

	    	map.panTo(here);

	    	geocoder.geocode({'location': here}, function(results, status) {
    			if (status == google.maps.GeocoderStatus.OK) {
     				if (results[0]) {
        
        				if(which == 0) {
        					infowindow.setContent("<strong> You are here: </strong> <small class='pull-right'> (drag marker) </small> <br>" + results[0].formatted_address);
        					$('#here').val(results[0].formatted_address);
        				}

        				if(which == 1) {
        					infowindow.setContent("<strong> Friend is here: </strong> <small class='pull-right'> (drag marker) </small><br>" + results[0].formatted_address);
        					$('#there').val(results[0].formatted_address);
        				}
        				infowindow.open(map, marker);


      				} else {
        				window.alert('No results found');
     				}
			    } else {
			      window.alert('Geocoder failed due to: ' + status);
			  	}
			});

	    }

	    var mid;
	    function calcRoute(m1, m2) {
	    	
	    	var travel_op=['DRIVING','BICYCLING','WALKING','TRANSIT'];

  			var start = m1.getPosition();
			var end = m2.getPosition();
			var request = {
			    origin:start,
			    destination:end,
			    travelMode: google.maps.TravelMode[travel_op[$('select').val()]]
			};
			directionsService.route(request, function(response, status) {
			    if (status == google.maps.DirectionsStatus.OK) {
			    	var m = getMidPoint(response);

			    	if(mid != null) {
			    		mid.setMap(null);
			    		mid=null;
			    	}

			    	mid = new google.maps.Marker({
	      				position: m,
	      				draggable:false,
	      				//icon:'./blue.png'
					});
					mid.setMap(map);
				
			    	directionsDisplay.setDirections(response);
			    	map.panTo(m);

			    }
			});
		}

		function totalLength(r) {
			var len=0;

    		for (var i = 0; i < r.legs.length; i++) 
       			len += r.legs[i].distance.value;

       		return len;
    	}

    	google.maps.LatLng.prototype.dist = function (point) {
    		return google.maps.geometry.spherical.computeDistanceBetween(this,point);
    	}

		function getMidPoint(e) {

			var d = totalLength(e.routes[0]);
			var route = e.routes[0].overview_path;

			var half = d/2;
			if (half==0) return route[0];

			var t = 0, prev=0;
			for(var i=0; i<route.length-1 && t<half; i++) {
				prev = t;
				t+=route[i].dist(route[i+1]);
			}

			if(t==half) return route[i];

			var ratio = (half-prev)/(t-prev);
			return google.maps.geometry.spherical.interpolate(route[i-1], route[i], ratio);
		}

					

		google.maps.event.addDomListener(window, 'load', getCoord);
	    </script>


	</head>
    <body>
    	
    	<div class="container-fluid">
	  		<div class="row">
	  			<div id="form" class="col-md-3">
	  				<img src="logo.png" class="img-responsive center-block" />
	  				<form>
  						<div class="form-group">
				    		<label class="text-info"> I'm leaving from: </label>
				    		<input type="text" class="form-control" id="here" placeholder="Enter address or drag blue marker">
				    		</input>
				 		</div>
				  		<div class="form-group">
				    		<label class="text-info">Friend is leaving from: </label>
				    		<input type="text" class="form-control" id="there" placeholder="Enter address or drag green marker">
				    		</input>
						</div>
						<div class="form-group">
							<label class="text-info">We're: </label>
							<select class="form-control">
								<option value="0"> Driving </option>
								<option value="1"> Cycling </option>
								<option value="2"> Walking </option>
								<option value="3"> Using public transport and walking </option>
							</select>
						</div>
						<div class="form-group">
							<label class="text-info">We're looking for a: </label>
							<div class="checkbox">
								<label>
								    <input type="checkbox" value="">
								    Restaurant
								</label>
							</div>
							<div class="checkbox">
								<label>
								    <input type="checkbox" value="">
								    Pub
								</label>
							</div>
							<div class="checkbox">
								<label>
								    <input type="checkbox" value="">
								    Club
								</label>
							</div>
							<div class="checkbox">
								<label>
								    <input type="checkbox" value="">
								    Commercial center
								</label>
							</div>		
						</div>
					</form>
					<button class="btn btn-default btn-primary pull-right" id="route"> Submit </button>
	  			</div>
				<div id="map-canvas" class="col-md-9"></div>
			</div>
		</div> 
		<!--<div id="map-canvas" ></div> -->

	</body>
</html>