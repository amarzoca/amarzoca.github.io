<!DOCTYPE html>
<html>
  	<head>

	  	<link rel="stylesheet" href="./css/bootstrap.css" /> 
	    <style type="text/css">
	    	html, body, .row, .container-fluid { 
		      	height: 100%; 
		      	width:100%; 
		      	margin: 0; 
		      	padding: 0;
	    	}
	    	.row > div {
	      		height:100%;
	      	}
	      	#map-canvas {
	       		padding: 0;
	   		}
	      	.checkbox {
	      		margin-left:8px; 
	      		margin-bottom:3px;
	      	}
	     	.checkbox:first-of-type {
	     		margin-top:-5px;
	     	}
	      
	    </style>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src= "http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>

	    <script type="text/javascript" src="./js/bootstrap.js"> </script>

	    <script type="text/javascript"
	      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDfEGRgJCleog0v6QuMAAa6U-JMObrn68&region=EU&libraries=places,geometry">
	    </script>

	    <script type="text/javascript">

	    var map;
	    var geocoder = new google.maps.Geocoder();
	    var autocomplete, places;

	    var directionsService = new google.maps.DirectionsService();
		var directionsDisplay = new google.maps.DirectionsRenderer({
			suppressMarkers: true,
			//preserveViewport: true
		});

		var markers, mid = new google.maps.InfoWindow();
		var resArray = new Array();
		var submit = false;


		google.maps.LatLng.prototype.dist = function (point) {
    		return google.maps.geometry.spherical.computeDistanceBetween(this,point);
    	}

    	google.maps.Marker.prototype.init = function () {
    		this.setMap(map);

    		var m=this;
    		google.maps.event.addListener(m, 'click', function() {
	  			m.info.open(map, this);
	  			map.panTo(this.getPosition());
	  		});
    	};

    	google.maps.Marker.prototype.setMarker = function (mes, which) {
    		var m=this;
	    	geocoder.geocode({'location': this.getPosition()}, function(results, status) {
    			if (status == google.maps.GeocoderStatus.OK) {
     				if (results[0]) {
        
        				if(which == 0) 
        					$('#here').val(results[0].formatted_address);
        		
        				if(which == 1) 
        					$('#there').val(results[0].formatted_address);

        				m.info.setContent(mes + results[0].formatted_address);
        				m.info.open(map, m);

      				} else {
        				window.alert('No results found');
     				}
			    } else {
			      window.alert('Geocoder failed due to: ' + status);
			  	}
			});
	    }

	    function getCoord() {
	      	var lat = 45.7597, lng = 21.2300;
	      	var here = new google.maps.LatLng(lat, lng);

	      	if (navigator.geolocation) {
	        	navigator.geolocation.getCurrentPosition(function (res) {
	        		lat = res.coords.latitude;
	        		lng = res.coords.longitude;
	        		here = new google.maps.LatLng(lat, lng);

	        		initialize(here);
	        	});
	    	} 
	    	else { 
	    		initialize(here);
	    	}
	  	}

	    function initialize(here) {

	    	var there = new google.maps.LatLng(here.lat()-0.001, here.lng()-0.004);
	 
	        var mapOptions = {
	        	center: here,
	          	zoom: 16
	        };

	        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	        directionsDisplay.setMap(map);

	        var marker = new google.maps.Marker({
	      		position: here,
	      		draggable:true,
	      		icon:'./blue.png',
	      		zIndex:1,
	      		form: new google.maps.places.Autocomplete(document.getElementById('here')),
	      		info: new google.maps.InfoWindow()
	    	});
	  
	    	var marker2 = new google.maps.Marker({
	      		position: there,
	      		draggable:true,
	      		icon:'./green.png',
	      		zIndex:1,
	      		form: new google.maps.places.Autocomplete(document.getElementById('there')),
	      		info: new google.maps.InfoWindow()
	    	});

	    	var markers = new Array(marker,marker2);

	  		markers.forEach(function(m,i) {

	  			var mes = ( i==0 ? "You are here:" : "Friend is here:") ;
	  			mes = "<strong>" + mes +  "</strong> <small class='pull-right'> (drag marker) </small> <br>";

	  			m.info.setContent("Search or drag marker");
	  			m.init();
	  			m.setMarker(mes, i);

		    	google.maps.event.addListener(m, 'dragend', function() {
		    		this.setMarker(mes, i);
		    		if(submit) calcRoute(marker, marker2);
		  		});

	  			google.maps.event.addListener(m.form, 'place_changed', function () {
		  			var res=m.form.getPlace();
	            	m.setPosition(res.geometry.location);
	            	map.panTo(m.getPosition());
	            	if(submit) calcRoute(marker, marker2);

	            	m.info.setContent(mes + res.formatted_address);
	        	});

	  		});
	  		map.setCenter(here);


        	$('#route').click(function () { 
	    		calcRoute(marker,marker2);
	    		submit=true;
	    	});

	    	$('select, input[type="checkbox"]').change(function() {
	    		if(submit) calcRoute(marker,marker2);
	    	});
	    }

	    function clear() {
	    	resArray.forEach(function (m) {
	    		m.setMap(null);
	    	});
	    	resArray = [];
	    }

	    function calcRoute(m1, m2) {

	    	clear();
	  
	    	var travel_op=['DRIVING','BICYCLING','WALKING','TRANSIT'];

  			var start = m1.getPosition();
			var end = m2.getPosition();
			var request = {
			    origin:start,
			    destination:end,
			    travelMode: google.maps.TravelMode[travel_op[$('select').val()]]
			};
			directionsService.route(request, function(response, status) {
			    if (status == google.maps.DirectionsStatus.OK) {
			    	var m = getMidPoint(response);

			    	if(mid != null) {
			    		mid.setMap(null);
			    		mid=null;
			    	}

			    	mid = new google.maps.Marker({
	      				draggable:false,
	      				icon:'./grey.png',
	      				position:m,
	      				zIndex:5
					});

					mid.info = new google.maps.InfoWindow();
			    	var mes = "<strong> Meet here </strong> <br>";
			    	mid.init(); mid.setMarker(mes, -1);

			    	directionsDisplay.setDirections(response);
			    	startSearch(m, totalLength(response.routes[0]));

				}
			});
		}

		function totalLength(r) {
			var len = 0;

    		for (var i = 0; i < r.legs.length; i++) 
       			len += r.legs[i].distance.value;

       		console.log(len);
       		return len;
    	}


		function getMidPoint(e) {

			var distance = totalLength(e.routes[0]);
			var route = e.routes[0].overview_path;

			var halfDist = distance/2;
			if (halfDist == 0) return route[0];

			var t = 0, prev=0;
			for(var i = 0; i < route.length-1 && t < halfDist; i++) {
				prev = t;
				t += route[i].dist(route[i+1]);
			}

			if(t == halfDist) return route[i];

			var ratio = (halfDist - prev)/(t - prev);
			return google.maps.geometry.spherical.interpolate(route[i-1], route[i], ratio);
		}


		function startSearch(x, len) {
			
			map.setCenter(x);

			var request = {
		    	location: x,
		    	types: getOptions()
		  	};

		  	if(len < 10000)
		  		request.rankBy = google.maps.places.RankBy.DISTANCE;
		  	else 
		  		request.radius = len/10;
		  	
		  	var service = new google.maps.places.PlacesService(map);
		  	service.nearbySearch(request, function (results, status) {
		  		if (status == google.maps.places.PlacesServiceStatus.OK) {
			    	for (var i = 0; i < results.length; i++) {
			      		createMarker(results[i]);
			    	}
			 	}
		  	});
		}

		var opt;
		function getOptions()
		{
			opt = [];

			if($('#r').is(":checked"))
				opt.push('restaurant', 'cafe');

			if($('#h').is(":checked"))
				opt.push('lodging');

			if($('#n').is(":checked"))
				opt.push('night_club','bar');

			if($('#m').is(":checked"))
				opt.push('museum','art_gallery');

			if($('#s').is(":checked"))
				opt.push('shopping_mall', 'clothing_store');

			return opt;
		}

		
		var infoRes = new google.maps.InfoWindow({
			zIndex: 10
		});

		function createMarker(place) {
			var placeLoc = place.geometry.location;
			var marker = new google.maps.Marker({
		    	map: map,
		    	position: place.geometry.location,
		    	icon: './yellow.png'
		  	});

		  	var request = {
  				placeId: place.place_id
			}

			service = new google.maps.places.PlacesService(map);
			service.getDetails(request, function (res, status) {
				if (status == google.maps.places.PlacesServiceStatus.OK) {

    				var content = getContent(res);
		  			google.maps.event.addListener(marker, 'click', function() {
		  				mid.info.close();
		    			infoRes.setContent(content);
		    			infoRes.open(map, this);
		  			});

		  			resArray.push(marker);
  				}
  				else marker.setMap(null);
			});		
			
		}

		function getContent(e) {

			var cont = "";
			cont += "<strong> " + e.name + "</strong> <br>";
			if(typeof e.vicinity != "undefined") cont += e.vicinity + "<br>";
			if(typeof e.website != "undefined") cont += "<a href='"+e.website+ "'>" + e.website + "</a> <br>";
			if(typeof e.url != "undefined") cont +=  "<a href='"+e.url+ "' target='_blank'> more info </a> <br>";

			return cont;
		}					

		google.maps.event.addDomListener(window, 'load', getCoord);
	    </script>

	    <script>
  			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
					(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
					m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

				ga('create', 'UA-65731914-1', 'auto');
				ga('send', 'pageview');

		</script>


	</head>
    <body>
    	
    	<div class="container-fluid">
	  		<div class="row">
	  			<div id="form" class="col-md-3">
	  				<img src="logo.png" class="img-responsive center-block" />
	  				<form>
  						<div class="form-group">
				    		<label class="text-info"> I'm leaving from: </label>
				    		<input type="text" class="form-control" id="here" placeholder="Enter address or drag blue marker">
				    		</input>
				 		</div>
				  		<div class="form-group">
				    		<label class="text-info">Friend is leaving from: </label>
				    		<input type="text" class="form-control" id="there" placeholder="Enter address or drag green marker">
				    		</input>
						</div>
						<div class="form-group">
							<label class="text-info">We're: </label>
							<select class="form-control">
								<option value="0"> Driving </option>
								<option value="1"> Cycling </option>
								<option value="2"> Walking </option>
								<option value="3"> Using public transport and walking </option>
							</select>
						</div>
						<div class="form-group">
							<label class="text-info">We're looking for a: </label>
							<div class="checkbox">
								<label>
								    <input type="checkbox" id="r" checked>
								    Restaurant or cafe
								</label>
							</div>
							<div class="checkbox">
								<label>
								    <input type="checkbox" id="h">
								    Hotel
								</label>
							</div>
							<div class="checkbox">
								<label>
								    <input type="checkbox" id="n">
								    Night club or bar
								</label>
							</div>
							<div class="checkbox">
								<label>
								    <input type="checkbox" id="m">
								    Museum or art gallery
								</label>
							</div>
							<div class="checkbox">
								<label>
								    <input type="checkbox" id="s">
								    Shopping center
								</label>
							</div>		
						</div>
					</form>
					<button class="btn btn-default btn-primary pull-right" id="route"> Submit </button>
	  			</div>
				<div id="map-canvas" class="col-md-9"></div>
			</div>
		</div> 
		<!--<div id="map-canvas" ></div> -->

	</body>
</html>